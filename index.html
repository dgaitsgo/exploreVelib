<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>velib</title>
		<script src="/socket.io/socket.io.js"></script>
		<script>
			var socket = io();
		</script>
		<script src='https://api.mapbox.com/mapbox-gl-js/v0.37.0/mapbox-gl.js'></script>
		<link href='https://api.mapbox.com/mapbox-gl-js/v0.36.0/mapbox-gl.css' rel='stylesheet' />
		<link rel="stylesheet" type="text/css" href="index.css">
	</head>
	<body style='background: #F9F9F9'>
		<div id='map' style='width: 1300px; height: 700px;'></div>
		<div id='console'>
			<h1>A Year of VÃ©lib</h1>
			<p><a href='https://developer.jcdecaux.com/#/home'>Data</a> from December 2016 to May 2017</p>
			<div class='session'>
				<h2>Availability Ratio</h2>
				<div class='row colors'>
				</div>
				<div class='row_labels'>
					<div class='label'>0.0</div>
					<div class='label'>0.5</div>
					<div class='label'>1.0</div>
				</div>

				<div class='session' id='sliderbar'>
					<h2>Date: <label id='active-date'>0:00</label></h2>
						<input id='slider-date' class='row' type='range' min='0' max='365' step='1' value='0' />
					<h2>Time: <label id='active-hour'>0:00</label></h2>
					<input id='slider-hour' class='row' type='range' min='0' max='23' step='1' value='0' />
				</div>
			</div>
		</div>
		<script>

			var currData;
			var map;
			var dateRange;

			function resetHourSlider(timestamp) {
				var date = new Date(timestamp * 1000);
				var minutes = date.getMinutes();
				if (minutes < 10)
					minutes = "0" + minutes;
				var s = date.getHours() + ":" + minutes;
				document.getElementById('active-hour').innerText = s;
			}

			function resetDateSlider(timestamp) {
				var date = new Date(timestamp * 1000);
				var s = date.getDate() + '/' + (date.getMonth() + 1) + '/' + date.getFullYear();
				console.log(date);
				document.getElementById('slider-hour').value = 0;
				document.getElementById('active-date').innerText = s;
			}

			socket.on('dateRange', function(data) {
				
				dateRange = data;
				
					//Adjust date slider:
				document.getElementById('slider-date').max = dateRange.length - 2;
				resetDateSlider(dateRange[0]);

					//Fetch Map:
				mapboxgl.accessToken =
				'pk.eyJ1IjoiaXNhYWNsdW1wa2lucyIsImEiOiJjajNhdTVlZXMwMGFnMzJvNzdoemQ0N3phIn0.hv3Atoq7kaBU9F-YCBGBOw';
				map = new mapboxgl.Map({
					container: 'map',
					zoom: 11,
					center: [2.3522, 48.8566],
					style: 'mapbox://styles/isaaclumpkins/cj3b5c6bp00082rpmdkhz0rhb'
				});

					//Get/set Initial data Initial Data
				socket.emit('fetchDay', dateRange[0], function (data) {
					currData = data;
					map.on('load', function () {
					map.addLayer(data.points);
					map.setFilter(dateRange[0], ['==', 'timestamp', data.timestamps[0]]);
					document.getElementById('slider-hour').max = data.timestamps.length - 1;
					resetHourSlider(data.timestamps[0]);
					});
				});
			});
			document.getElementById('slider-date').addEventListener('input', function(e) {
				var dateIndex = parseInt(e.target.value);
				resetDateSlider(dateRange[dateIndex]);
			});

			
			document.getElementById('slider-date').addEventListener('change', function(e) {
				var prevDate = currData.points.id;
					console.log(prevDate);
				var dateIndex = parseInt(e.target.value);
				var dateValue = dateRange[dateIndex];
				socket.emit('fetchDay', dateValue, function (data) {
					currData = data;
					map.removeLayer(prevDate);
					map.removeSource(prevDate);
					map.addLayer(data.points);
					map.setFilter(data.points.id, ['==', 'timestamp', data.timestamps[0]]);
					document.getElementById('slider-hour').max = data.timestamps.length - 1;
					resetHourSlider(data.timestamps[0]);
				});
			});
			document.getElementById('slider-hour').addEventListener('input', function(e) {
				var hour = parseInt(e.target.value);
				resetHourSlider(currData.timestamps[hour]);
				map.setFilter(currData.points.id, ['==', 'timestamp', currData.timestamps[hour]]);
			});
		</script>
	</body>
</html>